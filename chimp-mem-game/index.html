<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <title>Chimp Memory Game</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Test your short term memory: can you beat the results of the chimps in the Primate Research Institute in Inuyama, Japan?" />

  <meta name="twitter:card" content="summary" />
  <meta property="og:title" content="Chimp Memory Game" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://attilammagyar.github.io/toys/chimp-mem-game" />
  <meta property="og:image" content="https://attilammagyar.github.io/toys/chimp-mem-game/chimp-mem-game.jpg" />
  <meta property="og:image:alt" content="Screenshot of the game" />
  <meta property="og:image:width" content="1280" />
  <meta property="og:image:height" content="720" />
  <meta property="og:description" content="Test your short term memory: can you beat the results of the chimps in the Primate Research Institute in Inuyama, Japan?" />

<style>
* {
  font-family: Verdana, sans-serif;
  color: #bbc;
  margin: 0;
  padding: 0;
}

html, body {
  background-color: #000000;
  width: 100vw;
}

div.screen {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  transition: opacity 0.4s ease-in-out;
  height: 1vmin;
  overflow: hidden;
  width: 100vw;
  z-index: 0;
}

div.screen.active {
  opacity: 1;
  z-index: 10;
  height: 99vh;
  overflow: visible;
}

div.card {
  display: inline-block;
  width: 10vw;
  height: 16vh;
  margin: 0.75vh 0.75vw;
  font-size: 12vh;
  line-height: 16vh;
  font-weight: bold;
  text-align: center;
  cursor: pointer;
  transition: color 0.1s ease-in-out, background-color 0.1s ease-in-out;
  border-radius: 1vmin;
  z-index: 15;
}

div.card.revealed {
  color: rgba(208, 208, 222, 1);
  background-color: #000;
}

div.card.hidden {
  color: rgba(0, 0, 0, 0);
  background-color: #000;
}

div.card.wrong {
  background-color: #800000;
}

div.card.expected {
  background-color: #007000;
}

div.card.value_hidden {
  color: rgba(112, 112, 122, 0);
  background-color: #70707a;
}

#status {
  height: 10vh;
  line-height: 10vh;
  font-size: 3.3vh;
  color: red;
  padding: 0 3vw 0 0;
  text-align: right;
}

div.settings {
  margin-top: 2vh;
  text-align: center;
}

div.options {
  display: inline-block;
  margin: 0 0 0.2vmax 0;
  padding: 0;
  text-align: center;
  width: 160vmin;
  max-width: 96vw;
}

div.options div {
  display: inline-block;
  margin: 0;
  padding: 0;
}

div.options label {
  cursor: pointer;
  display: block;
  height: 2.3vmax;
  line-height: 2.3vmax;
  font-size: 2.1vmax;
  margin: 0.03vmax;
  border: solid 0.3vmax #bbc;
  border-radius: 12vmax;
  background-color: #000;
}

div.cards label,
div.rounds label {
  width: 5vmax;
}

div.difficulty label {
  width: 12vmax;
}

div.auto-hide label {
  width: 7.2vmax;
}

div.settings input[type="radio"] {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  width: 0;
  height: 0;
}

div.settings input[type="radio"]:checked + label {
  background-color: #bbc;
  color: #000;
}

button {
  cursor: pointer;
  height: 8vmax;
  width: 42vmax;
  font-weight: bold;
  border: outset 0.5vmax #bbc;
  border-radius: 15vmax;
  font-size: 3.2vmax;
  line-height: 3.2vmax;
  background-color: #000;
}

#sound-settings {
  position: absolute;
  top: 0;
  left: 0;
  height: 10vh;
  line-height: 10vh;
  z-index: 20;
}

#sound-settings input[type="checkbox"],
#status input[type="checkbox"] {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  width: 0;
  height: 0;
}

#status label img,
#sound-settings label svg {
  cursor: pointer;
  padding-top: 1.6vh;
  margin-left: 1vmin;
  height: 7vh;
  width: 7vh;
}

#sound-settings input[type="checkbox"]:checked + label #sound-on {
  display: none;
}

#sound-settings input[type="checkbox"]:not(:checked) + label #sound-on {
  display: auto;
}

#sound-settings input[type="checkbox"]:checked + label #sound-off {
  display: auto;
}

#sound-settings input[type="checkbox"]:not(:checked) + label #sound-off {
  display: none;
}

@media only screen and (orientation: portrait) {
  div.card {
    display: inline-block;
    width: 16vw;
    height: 9.5vh;
    margin: 0.75vh 0.75vw;
    font-size: 7vh;
    line-height: 10vh;
  }
}

.screen h1,
.screen h2,
.screen p {
  text-align: center;
  margin: 2vmin auto 1vmin auto;
  width: 80vw;
}

.screen h1 {
  font-size: 3.2vmax;
}

.screen h2 {
  font-size: 2.3vmax;
}

.screen p {
  font-size: 2.0vmax;
  line-height: 3.0vmax;
}

.screen p.small {
  margin: 0.5vmin auto 3vmin auto;
  font-size: 1.4vmax;
  line-height: 1.8vmax;
}

.screen p a {
  color: #8787ff;
  font-weight: bold;
}

#statistics {
  margin: auto;
}

#statistics tr th,
#statistics tr td {
  font-weight: normal;
  font-size: 2.5vmax;
  min-width: 20vw;
}

#statistics th {
  text-align: left;
}

#statistics tr {
  text-align: right;
}

#copy-button,
#tweet {
  cursor: pointer;
  display: inline-block;
  height: 5vmax;
  width: 32vmax;
  margin: 0.5vmax;
  font-weight: normal;
  border: outset 0.3vmax #bbc;
  border-radius: 15vmax;
  font-size: 2.5vmax;
  line-height: 5vmax;
  background-color: #000;
}

#start-round {
  display: none;
  width: 0;
  height: 0;
  border-radius: 10vh;
  border: outset 1vmax #bbc;
  cursor: pointer;
  font-weight: bold;
  font-size: 7vh;
  line-height: 7vh;
  background-color: #000;
}

#start-round.visible {
  display: block;
  position: absolute;
  width: 80vw;
  height: 20vh;
  bottom: 10vh;
  left: 10vw;
  z-index: 30;
}

#copy-text {
  margin: 2vmin;
  font-size: 2vmax;
  width: 70vw;
  height: 20vh;
  background-color: #000;
  color: #bbc;
  border-radius: 1vmax;
  border: inset 0.3vmax #bbc;
  padding: 0.3vmax;
}

#stats-history-score,
#stats-history-time {
  width: 80vw;
  height: 36vmin;
}

div.stats-history {
  text-align: center;
}

</style>
</head>
<body>
  <form id="form" action="#" method="get">
    <div id="intro" class="screen active">
      <h1>Chimp Memory Game</h1>
      <div class="settings">
        <p>How many numbers do you want to memorize?</p>
        <div class="options">
          <div class="cards">
            <input type="radio" id="cards-3" name="cards" value="3" />
            <label for="cards-3">3</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-4" name="cards" value="4" />
            <label for="cards-4">4</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-5" name="cards" value="5" checked="checked" />
            <label for="cards-5">5</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-6" name="cards" value="6" />
            <label for="cards-6">6</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-7" name="cards" value="7" />
            <label for="cards-7">7</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-8" name="cards" value="8" />
            <label for="cards-8">8</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-9" name="cards" value="9" />
            <label for="cards-9">9</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Select the difficulty level:</p>
        <div class="options">
          <div class="difficulty">
            <input type="radio" id="difficulty-1" name="difficulty" value="1" checked="checked" />
            <label for="difficulty-1">Easy</label>
          </div>
          <div class="difficulty">
            <input type="radio" id="difficulty-2" name="difficulty" value="2" />
            <label for="difficulty-2">Medium</label>
          </div>
          <div class="difficulty">
            <input type="radio" id="difficulty-3" name="difficulty" value="3" />
            <label for="difficulty-3">Hard</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Number of rounds:</p>
        <div class="options">
          <div class="rounds">
            <input type="radio" id="rounds-0" name="rounds" value="5" />
            <label for="rounds-0">5</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-1" name="rounds" value="10" checked="checked" />
            <label for="rounds-1">10</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-2" name="rounds" value="15" />
            <label for="rounds-2">15</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-3" name="rounds" value="20" />
            <label for="rounds-3">20</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-4" name="rounds" value="30" />
            <label for="rounds-4">30</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Auto-hide numbers:</p>
        <div class="options">
          <div class="auto-hide">
            <input type="radio" id="auto-hide-0" name="auto-hide" value="off" checked="checked" />
            <label for="auto-hide-0">Off</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-1" name="auto-hide" value="50" />
            <label for="auto-hide-1">.05s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-2" name="auto-hide" value="110" />
            <label for="auto-hide-2">.11s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-3" name="auto-hide" value="160" />
            <label for="auto-hide-3">.16s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-4" name="auto-hide" value="210" />
            <label for="auto-hide-4">.21s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-5" name="auto-hide" value="270" />
            <label for="auto-hide-5">.27s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-6" name="auto-hide" value="320" />
            <label for="auto-hide-6">.32s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-7" name="auto-hide" value="430" />
            <label for="auto-hide-7">.43s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-8" name="auto-hide" value="540" />
            <label for="auto-hide-8">.54s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-9" name="auto-hide" value="650" />
            <label for="auto-hide-9">.65s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-10" name="auto-hide" value="830" />
            <label for="auto-hide-10">.83s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-11" name="auto-hide" value="1000" />
            <label for="auto-hide-11">1s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-12" name="auto-hide" value="2000" />
            <label for="auto-hide-12">2s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-13" name="auto-hide" value="4000" />
            <label for="auto-hide-13">4s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-14" name="auto-hide" value="8000" />
            <label for="auto-hide-14">8s</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <button id="start" type="submit">Start Game!</button>
      </div>
      <p>
        Test your short term memory: can you beat the results of the
        chimps in the
        <a href="https://en.wikipedia.org/wiki/Primate_Research_Institute"
          target="_blank">Primate Research Institute</a> in Inuyama, Japan?
        Memorize the randomly scattered numbers, then click or touch
        them in ascending order - if you can.
      </p>
      <p>
        This game is a clone of the memory test shown in
        <a href="https://www.youtube.com/watch?v=ktkjUjcZid0"
          target="_blank">Mindfield S03E01: The Cognitive Tradeoff Hypothesis (24:21)</a>
        and in <a href="https://www.youtube.com/watch?v=zsXP8qeFF6A"
          target="_blank">this video from BBC Earth (3:42)</a>.
      </p>
      <h1>Recent Games</h1>
      <h2>Score Per Round</h2>
      <div class="stats-history">
        <svg id="stats-history-score" viewBox="0 0 630 110" xmlns="http://www.w3.org/2000/svg">
          <style>
            text {
              font: 8px sans-serif;
              fill: #ddd;
              width: 23px;
              text-align: right;
            }

            .easy { fill: #08f; }
            .medium { fill: #ff0; }
            .hard { fill: #f80; }
          </style>
          <g>
            <path stroke-width="1" stroke="#bbb" d="M25,105 L629,105 M30,1 L30,109 M25,5 L629,5 M25,55 L629,55" />
            <text id="stats-history-score-min" text-anchor="end" x="24" y="107"></text>
            <text id="stats-history-score-mid" text-anchor="end" x="24" y="57"></text>
            <text id="stats-history-score-max" text-anchor="end" x="24" y="7"></text>
          </g>
          <g id="stats-history-score-chart">
          </g>
        </svg>
      </div>
      <h2>Memorization Time</h2>
      <div class="stats-history">
        <svg id="stats-history-time" viewBox="0 0 630 110" xmlns="http://www.w3.org/2000/svg">
          <style>
            text {
              font: 8px sans-serif;
              fill: #ddd;
              width: 23px;
              text-align: right;
            }

            .easy { fill: #08f; }
            .medium { fill: #ff0; }
            .hard { fill: #f80; }
          </style>
          <g>
            <path stroke-width="1" stroke="#bbb" d="M25,105 L629,105 M30,1 L30,109 M25,5 L629,5 M25,55 L629,55" />
            <text id="stats-history-time-min" text-anchor="end" x="24" y="107"></text>
            <text id="stats-history-time-mid" text-anchor="end" x="24" y="57"></text>
            <text id="stats-history-time-max" text-anchor="end" x="24" y="7"></text>
          </g>
          <g id="stats-history-time-chart">
          </g>
        </svg>
      </div>
      <p class="small">
        Horizontal ticks show the slowest, fastest, and the mean memorization
        time, a circle shows the median, and the thick line shows the standard
        deviation around the mean.
      </p>
      <p>
        <a id="stats-history-save" href="#">Save statistics as tab-separated values (TSV)</a>.
      </p>
      <p>
        <a href="https://github.com/attilammagyar/toys"
          target="_blank">Source code on GitHub</a>
      </p>
      <p>
        (By the way, this website doesn't use any cookies.)
      </p>
    </div>
    <div id="game" class="screen">
      <div id="sound-settings">
        <input type="checkbox" id="mute" name="mute" checked="checked" />
        <label for="mute">
          <svg id="sound-on" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
           <g>
            <title>Sound: ON</title>
            <path stroke="#d0d0de" id="svg_10" d="m72.5,186.90556l0,131.80502l70.71604,0l105.86168,92.24348l0.06293,-316.29197l-105.87741,92.24348l-70.76324,0zm217.22961,-15.15691c-6.18274,-6.49343 -16.10973,-6.49343 -22.261,0.03339c-6.13554,6.52682 -6.13554,17.09325 0.03146,23.63677l0,-0.03339c13.57685,14.42243 21.94636,34.2032 21.94636,56.1874c0,21.9675 -8.35377,41.6815 -21.91489,56.10393c-6.19847,6.49343 -6.19847,17.05987 -0.03146,23.62007c3.06777,3.25506 7.0952,4.89094 11.12263,4.89094c4.04316,0 8.0706,-1.63588 11.13837,-4.89094c19.22469,-20.36501 31.14967,-48.65902 31.13394,-79.72401c0.01573,-31.13176 -11.95644,-59.45915 -31.1654,-79.82416zm36.1053,-38.2929c-6.18274,-6.52682 -16.10973,-6.52682 -22.22954,0c-6.16701,6.52682 -6.16701,17.10995 0,23.60338c22.81163,24.22101 36.87617,57.5395 36.87617,94.49698c0,36.9241 -14.06455,70.2259 -36.84471,94.4636c-6.16701,6.51013 -6.16701,17.07656 0,23.60338c3.06777,3.25506 7.0952,4.89094 11.13837,4.89094c4.02743,0 8.05486,-1.63588 11.12263,-4.89094c28.44374,-30.19697 46.07949,-72.0287 46.04802,-118.06698c0.01573,-46.07166 -17.62001,-87.93678 -46.11095,-118.10037zm34.28037,-36.37324c-6.18274,-6.52682 -16.12546,-6.49343 -22.24527,0.03339c-6.15127,6.49343 -6.15127,17.07656 0.03146,23.58669l-0.03146,0c31.6059,33.5355 51.09804,79.67393 51.09804,130.85354c0,51.12953 -19.49214,97.28465 -51.06658,130.83684c-6.15127,6.51013 -6.15127,17.07656 0.03146,23.62007c3.05204,3.23837 7.07947,4.85756 11.1069,4.85756s8.0706,-1.63588 11.13837,-4.89094c37.17509,-39.49477 60.26989,-94.19652 60.23843,-154.42353c0.03146,-60.27709 -23.06334,-114.99554 -60.30135,-154.47361z" stroke-width="6" fill="#d0d0de"/>
           </g>
          </svg>
          <svg id="sound-off" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
           <g>
            <title>Sound: OFF</title>
            <path stroke="#d0d0de" id="svg_10" d="m72.5,186.90556l0,131.80502l70.71604,0l105.86168,92.24348l0.06293,-316.29197l-105.87741,92.24348l-70.76324,0z" stroke-width="6" fill="#4c4c51"/>
            <rect transform="rotate(45 250 255)" id="svg_11" height="560" width="50" y="-25.00034" x="225" stroke-width="6" stroke="#d0d0de" fill="#d0d0de"/>
           </g>
          </svg>
        </label>
      </div>
      <div id="status">
        <span id="status-text"></span>
      </div>
      <button id="start-round">
        Start
      </button>
    </div>
    <div id="end" class="screen">
      <h1>Statistics</h1>
      <table id="statistics">
        <tr><th>Score:</th><td id="stats-score"></td></tr>
        <tr><th>Rounds:</th><td id="stats-rounds"></td></tr>
        <tr><th>Perfect rounds:</th><td id="stats-perfect-rounds"></td></tr>
        <tr><th>Mean memorization time:</th><td id="stats-mem-time-mean"></td></tr>
        <tr><th>Standard deviation:</th><td id="stats-mem-time-sd"></td></tr>
        <tr><th>Median memorization time:</th><td id="stats-mem-time-median"></td></tr>
        <tr><th>Fastest memorization time:</th><td id="stats-mem-time-min"></td></tr>
        <tr><th>Slowest memorization time:</th><td id="stats-mem-time-max"></td></tr>
      </table>
      <div class="settings">
        <a id="copy-button">Copy to clipboard</a>
        <a id="tweet" href="#" target="_blank">Share on Twitter</a>
        <br/>
        <textarea id="copy-text" name="copy-text" rows="3" cols="70" readonly="readonly"></textarea>
      </div>
      <div class="settings">
        <button id="restart">New Game</button>
      </div>
    </div>
  </form>
<script type="text/javascript">
<!--
(function () {

"use strict";

function $(id)
{
    return document.getElementById(id);
}

var CARDS = 40,

    EASY = 1,
    MEDIUM = 2,
    HARD = 3,

    SHARE_URL = "https://attilammagyar.github.io/toys/chimp-mem-game",
    SHARE_TEXT = "I just scored {score} in the Chimp Memorization Game on {difficulty} level with {numbers} numbers in {rounds} rounds.",
    SHARE_STATS = " Fastest memorization time: {min}s (mean: {mean}s, median: {median}s, SD: {sd}s).",
    SHARE_AUTO_HIDE = " Auto-hide: {auto-hide}s.",
    SHARE_PERFECT_ROUNDS = " Perfect rounds: {perfect_rounds}.",
    SHARE_HASHTAGS = " #MindField",

    LOCAL_STORAGE_KEY = "chimp_mem_game",

    VOLUME = 0.35,

    STATS_HISTORY_MAX_LENGTH = 1000,

    start_round_btn_node = null,
    mute_node = null,
    tweet_node = null,
    copy_text_node = null,
    stats_round_node = null,
    stats_score_node = null,
    stats_perfect_rounds_node = null,
    game_node = null,
    end_node = null,
    intro_node = null,
    stats_history = null,
    stats_history_save_node = null,
    stats_score_history_chart_node = null,
    stats_score_history_min_node = null,
    stats_score_history_mid_node = null,
    stats_score_history_max_node = null,
    stats_time_history_chart_node = null,
    stats_time_history_min_node = null,
    stats_time_history_mid_node = null,
    stats_time_history_max_node = null,
    stats_mem_time_mean_node = null,
    stats_mem_time_min_node = null,
    stats_mem_time_max_node = null,
    stats_mem_time_median_node = null,
    stats_mem_time_sd_node = null,
    status_text_node = null,
    card_num_nodes = {},
    difficulty_nodes = {},
    rounds_nodes = {},
    auto_hide_nodes = {},
    numbers = 3,
    rounds = 10,
    card_nodes = [],
    card_values = [],
    expected_values = [],
    done_memorizing = false,
    score_bonus = 1.0,
    accept_card_touches = false,
    difficulty = 0,
    auto_hide = null,
    round = 0,
    score = 0,
    perfect_rounds = 0,
    memorization_times = [],
    memorization_start = 0,
    hiding_timer = null,
    audio_ctx = null,
    is_audio_suspended = false,
    soft_saw_wave = null,
    soft_sqr_wave = null,
    win_frequency = 1108.73,
    win_lfo_freq_shaper_curve = null,
    win_lfo_amp_shaper_curve = null,
    wrong_frequency_1 = 311.13,
    wrong_frequency_2 = null,
    wrong_freq_curve = null,
    wrong_amp_curve = null;

function time()
{
    return (new Date()).getTime() / 1000;
}

function format_stats(n)
{
    return String(Math.round(n * 100) / 100);
}

function num_cmp(a, b)
{
    return a - b;
}

function build_statistics(arr)
{
    var l = arr.length,
        mean, sd, median, sum, i, m, d;

    if (l < 1) {
        return {
            "valid": false,
            "min": 0,
            "max": 0,
            "mean": 0,
            "median": 0,
            "sd": 0,
            "min_str": "?",
            "max_str": "?",
            "mean_str": "?",
            "median_str": "?",
            "sd_str": "?"
        };
    }

    arr.sort(num_cmp);

    for (i = 0, sum = 0; i < l; ++i) {
        sum += arr[i];
    }

    mean = sum / l;

    for (i = 0, sum = 0; i < l; ++i) {
        d = arr[i] - mean;
        sum += d * d;
    }

    sd = Math.sqrt(sum / l);

    m = Math.floor(l / 2.0);

    if (l % 2 == 0) {
        median = (arr[m - 1] + arr[m]) / 2.0;
    } else {
        median = arr[m];
    }

    return {
        "valid": true,
        "min": arr[0],
        "max": arr[l - 1],
        "mean": mean,
        "median": median,
        "sd": sd,
        "min_str": format_stats(arr[0]),
        "max_str": format_stats(arr[l - 1]),
        "mean_str": format_stats(mean),
        "median_str": format_stats(median),
        "sd_str": format_stats(sd)
    };
}

function clear_selection()
{
    try {
        window.getSelection().removeAllRanges();
    } catch (ex) {}
}

function update_status()
{
    status_text_node.innerHTML = (
        "Score: " + String(score)
        + " (Round " + String(round) + "/" + String(rounds) + ")"
    );
}

function is_mute()
{
    if (audio_ctx === null) {
        return true;
    }

    if (mute_node.checked) {
        suspend_audio();

        return true;
    }

    resume_audio();

    return false;
}

function suspend_audio()
{
    if (is_audio_suspended) {
        return;
    }

    is_audio_suspended = true;
    audio_ctx.suspend();
}

function resume_audio()
{
    if (!is_audio_suspended) {
        return;
    }

    is_audio_suspended = false;
    audio_ctx.resume();
}

function play_click_sound()
{
    var osc, gain_env, start, ac;

    if (is_mute()) {
        return;
    }

    ac = audio_ctx;

    osc = new OscillatorNode(ac, {"channelCount": 1});
    gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});

    start = ac.currentTime + 0.05;

    start_envelope(gain_env, start, 0.002, 0.005, 0.02);

    osc.type = "square";
    osc.frequency.value = 660.0;

    osc.connect(gain_env);
    gain_env.connect(ac.destination);

    osc.start(start);

    setTimeout(
        function ()
        {
            gain_env.disconnect(ac.destination);
            osc.disconnect(gain_env);
        },
        300
    );
}

function start_envelope(gain_env, time, attack, hold, decay)
{
    gain_env.gain.setValueAtTime(0.0, time);

    time += attack;
    gain_env.gain.linearRampToValueAtTime(VOLUME, time);

    time += hold;
    gain_env.gain.setValueAtTime(VOLUME, time);

    time += decay;
    gain_env.gain.linearRampToValueAtTime(0.0, time);
}

function play_win_sound()
{
    var osc, gain_env, gain_amp,
        lfo_freq, lfo_freq_shaper,
        lfo_amp, lfo_amp_shaper,
        start, ac;

    if (is_mute()) {
        return;
    }

    ac = audio_ctx;

    osc = new OscillatorNode(
        ac, {"channelCount": 1, "type": "sine", "frequency": win_frequency}
    );
    gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
    gain_amp = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
    lfo_freq = new OscillatorNode(
        ac, {"channelCount": 1, "periodicWave": soft_saw_wave, "frequency": 12.0}
    );
    lfo_freq_shaper = new WaveShaperNode(
        ac, {"channelCount": 1, "curve": win_lfo_freq_shaper_curve}
    );
    lfo_amp = new OscillatorNode(
        ac, {"channelCount": 1, "type": "triangle", "frequency": 6.0}
    );
    lfo_amp_shaper = new WaveShaperNode(
        ac, {"channelCount": 1, "curve": win_lfo_amp_shaper_curve}
    );

    start = ac.currentTime + 0.05;

    start_envelope(gain_env, start, 0.03, 1.2, 0.05);

    osc.connect(gain_amp);
    gain_amp.connect(gain_env);
    gain_env.connect(ac.destination);

    lfo_freq.connect(lfo_freq_shaper);
    lfo_freq_shaper.connect(osc.frequency);

    lfo_amp.connect(lfo_amp_shaper);
    lfo_amp_shaper.connect(gain_amp.gain);

    lfo_freq.start(start);
    lfo_amp.start(start);
    osc.start(start);

    setTimeout(
        function ()
        {
            gain_env.disconnect(ac.destination);
            gain_amp.disconnect(gain_env);
            osc.disconnect(gain_amp);
            lfo_freq_shaper.disconnect(osc.frequency);
            lfo_freq.disconnect(lfo_freq_shaper);
            lfo_amp_shaper.disconnect(gain_amp.gain);
            lfo_amp.disconnect(lfo_amp_shaper);
        },
        2000
    );
}

function play_wrong_sound()
{
    var modulator, carrier,
        amp_shaper, freq_shaper,
        gain_env, gain_amp,
        start, ac;

    if (is_mute()) {
        return;
    }

    ac = audio_ctx;

    carrier = new OscillatorNode(
        ac,
        {
            "channelCount": 1,
            "periodicWave": soft_saw_wave,
            "frequency": wrong_frequency_1
        }
    );
    modulator = new OscillatorNode(
        ac,
        {
            "channelCount": 1,
            "periodicWave": soft_sqr_wave,
            "frequency": wrong_frequency_2
        }
    );
    gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
    gain_amp = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
    amp_shaper = new WaveShaperNode(
        ac, {"channelCount": 1, "curve": wrong_amp_curve}
    );
    freq_shaper = new WaveShaperNode(
        ac, {"channelCount": 1, "curve": wrong_freq_curve}
    );

    start = ac.currentTime + 0.05;

    start_envelope(gain_env, start, 0.003, 0.6, 0.03);

    modulator.connect(amp_shaper);
    amp_shaper.connect(gain_amp.gain);

    modulator.connect(freq_shaper);
    freq_shaper.connect(carrier.frequency);

    carrier.connect(gain_amp);
    gain_amp.connect(gain_env);
    gain_env.connect(ac.destination);

    modulator.start(start);
    carrier.start(start);

    setTimeout(
        function ()
        {
            gain_env.disconnect(ac.destination);
            gain_amp.disconnect(gain_env);
            carrier.disconnect(gain_amp);
            modulator.disconnect(amp_shaper);
            amp_shaper.disconnect(gain_amp.gain);
            modulator.disconnect(freq_shaper);
            freq_shaper.disconnect(carrier.frequency);
        },
        2000
    );
}

function handle_wrong_card(clicked_card_index, expected_value)
{
    var i;

    reveal_cards();

    for (i = 0; i < CARDS; ++i) {
        if (card_values[i] == expected_value) {
            card_nodes[i].setAttribute("class", "card revealed expected");
        } else if (card_values[i]) {
            card_nodes[i].setAttribute("class", "card revealed");
        }
    }

    card_nodes[clicked_card_index].setAttribute("class", "card revealed wrong");
    play_wrong_sound();

    setTimeout(prepare_next_round, 1000);
}

function handle_perfect_round()
{
    play_win_sound();
    prepare_next_round();
    ++perfect_rounds;
}

function handle_card_touch(evt)
{
    var now = time(),
        delta, clicked_card_index, card_value, card_node;

    if (!accept_card_touches) {
        clear_selection();

        return false;
    }

    accept_card_touches = false;

    clicked_card_index = evt.target.getAttribute("id").match(/^card-([0-9]+)$/);

    if (!clicked_card_index) {
        accept_card_touches = true;

        return false;
    }

    evt = evt || window.event;
    evt.stopPropagation();
    evt.preventDefault();
    clear_selection();

    clicked_card_index = Number(clicked_card_index[1]);
    card_node = card_nodes[clicked_card_index];

    if (!card_node) {
        accept_card_touches = true;

        return false;
    }

    if (done_memorizing && card_node.getAttribute("class").match(/revealed/)) {
        accept_card_touches = true;

        return false;
    }

    card_value = Number(card_values[clicked_card_index]);

    if (difficulty == EASY && !card_value) {
        accept_card_touches = true;

        return false;
    }

    play_click_sound();

    if (card_value != expected_values[0]) {
        handle_wrong_card(clicked_card_index, expected_values[0]);

        return false;
    }

    if (!done_memorizing) {
        done_memorizing = true;
        delta = now - memorization_start;

        if (auto_hide !== null) {
            delta = Math.min(delta, auto_hide / 1000);
        }

        score_bonus = Math.max(1.0, 3.0 * (1.0 - delta));
        memorization_times.push(delta);
        hide_card_values();
    }

    expected_values = expected_values.slice(1);
    score += Math.round(
        score_bonus * difficulty * (numbers - expected_values.length)
    );
    update_status();

    reveal_card(clicked_card_index);
    card_node.setAttribute("class", "card revealed");

    if (expected_values.length === 0) {
        handle_perfect_round();

        return false;
    }

    accept_card_touches = true;

    return false;
}

function randomize_card_values()
{
    var i;

    expected_values = [1, 2, 3, 4, 5, 6, 7, 8, 9];

    shuffle(expected_values);
    expected_values = expected_values.slice(0, numbers);
    expected_values.sort(num_cmp);

    card_values = [];

    for (i = 0; i < CARDS; ++i) {
        card_values.push(i < numbers ? String(expected_values[i]) : "");
    }

    shuffle(card_values);
}

function shuffle(arr)
{
    var i, j, tmp, l = arr.length;

    for (i = l - 1; i > 0; --i) {
        j = Math.floor(Math.random() * l);
        tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
    }
}

function reveal_cards()
{
    var i;

    for (i = 0; i < CARDS; ++i) {
        reveal_card(i);
    }
}

function hide_cards()
{
    var i, card_node;

    for (i = 0; i < CARDS; ++i) {
        card_node = card_nodes[i];
        card_node.setAttribute("class", "card hidden");
        card_node.innerHTML = "&nbsp;";
    }
}

function hide_card_values()
{
    var i;

    if (hiding_timer !== null) {
        clearTimeout(hiding_timer);
        hiding_timer = null;
    }

    for (i = 0; i < CARDS; ++i) {
        hide_card_value(i);
    }
}

function hide_card_value(i)
{
    var card_node = card_nodes[i];

    card_node.innerHTML = "&nbsp;";

    switch (difficulty) {
        case EASY:
            if (card_values[i]) {
                card_node.setAttribute("class", "card value_hidden");
            } else {
                card_node.setAttribute("class", "card hidden");
            }

            break;

        case MEDIUM:
        case HARD:
            card_node.setAttribute("class", "card value_hidden");

            break;

        default:
            card_node.setAttribute("class", "card hidden");
    }
}

function reveal_card(i)
{
    var card_node = card_nodes[i],
        value = card_values[i];

    card_node.innerHTML = value ? value : "&nbsp;";

    if (difficulty === MEDIUM) {
        if (value) {
            card_node.setAttribute("class", "card revealed");
        } else {
            card_node.setAttribute("class", "card value_hidden");
        }
    } else {
        card_node.setAttribute("class", "card revealed");
    }
}

function prepare_next_round()
{
    ++round;
    accept_card_touches = false;

    if (auto_hide !== null) {
        start_round_btn_node.setAttribute("class", "");
    }

    if (round <= rounds) {
        setTimeout(
            function ()
            {
                hide_cards();
                update_status();

                if (auto_hide !== null) {
                    setTimeout(prepare_round, 500);
                } else {
                    setTimeout(start_round, 500);
                }
            },
            500
        );
    } else {
        setTimeout(show_end_screen, 1500);
    }
}

function prepare_round()
{
    start_round_btn_node.setAttribute("class", "visible");
}

function start_round()
{
    start_round_btn_node.setAttribute("class", "");
    randomize_card_values();
    reveal_cards();
    accept_card_touches = true;
    done_memorizing = false;
    score_bonus = 1.0;
    memorization_start = time();

    if (auto_hide !== null) {
        hiding_timer = setTimeout(hide_card_values, auto_hide);
    }
}

function format_number_with_units(n, unit)
{
    if (n == 1) {
        return String(n) + " " + unit;
    }

    return String(n) + " " + unit + "s";
}

function show_end_screen()
{
    var difficulty_str = ["easy", "medium", "hard"][difficulty - 1],
        stats = build_statistics(memorization_times),
        share_text;

    hide_cards();
    suspend_audio();

    share_text = (
        SHARE_TEXT
            .replace("{score}", format_number_with_units(score, "point"))
            .replace("{numbers}", String(numbers))
            .replace("{difficulty}", difficulty_str)
            .replace("{rounds}", rounds)
    );

    if (stats["valid"]) {
        share_text += (
            SHARE_STATS
                .replace("{min}", stats["min_str"])
                .replace("{mean}", stats["mean_str"])
                .replace("{sd}", stats["sd_str"])
                .replace("{median}", stats["median_str"])
        );
    }

    if (auto_hide !== null) {
        share_text += (
            SHARE_AUTO_HIDE
                .replace(
                    "{auto-hide}",
                    format_stats(auto_hide / 1000)
                )
        );
    }

    if (perfect_rounds > 0) {
        share_text += SHARE_PERFECT_ROUNDS.replace(
            "{perfect_rounds}", String(perfect_rounds)
        );
    }

    share_text += SHARE_HASHTAGS;

    tweet_node.setAttribute(
        "href",
        [
            "https://twitter.com/intent/tweet?text=",
            escape(share_text),
            "&url=",
            escape(SHARE_URL)
        ].join("")
    );
    copy_text_node.value = share_text + " " + SHARE_URL;

    stats_round_node.innerHTML = rounds;
    stats_score_node.innerHTML = score;
    stats_perfect_rounds_node.innerHTML = perfect_rounds;

    if (stats["valid"]) {
        stats_mem_time_mean_node.innerHTML = stats["mean_str"] + "s";
        stats_mem_time_min_node.innerHTML = stats["min_str"] + "s";
        stats_mem_time_max_node.innerHTML = stats["max_str"] + "s";
        stats_mem_time_median_node.innerHTML = stats["median_str"] + "s";
        stats_mem_time_sd_node.innerHTML = stats["sd_str"] + "s";

        stats_history.push(
            [
                memorization_start,
                difficulty,
                numbers,
                rounds,
                auto_hide === null ? 0 : auto_hide,
                score,
                perfect_rounds,
                stats["mean"],
                stats["sd"],
                stats["median"],
                stats["min"],
                stats["max"]
            ]
        );

        stats_history = truncate_stats_history(stats_history);
        store_stats_history();
    } else {
        stats_mem_time_mean_node.innerHTML = "N/A";
        stats_mem_time_min_node.innerHTML = "N/A";
        stats_mem_time_max_node.innerHTML = "N/A";
        stats_mem_time_median_node.innerHTML = "N/A";
        stats_mem_time_sd_node.innerHTML = "N/A";
    }

    game_node.setAttribute("class", "screen");
    end_node.setAttribute("class", "screen active");
}

function store_stats_history()
{
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stats_history));
}

function start_game()
{
    var key, radio_btn, ex;

    if (audio_ctx === null) {
        init_audio();
    }

    for (key in card_num_nodes) {
        if (card_num_nodes.hasOwnProperty(key)) {
            radio_btn = card_num_nodes[key];

            if (radio_btn.checked) {
                numbers = Number(radio_btn.value);
                break;
            }
        }
    }

    for (key in difficulty_nodes) {
        if (difficulty_nodes.hasOwnProperty(key)) {
            radio_btn = difficulty_nodes[key];

            if (radio_btn.checked) {
                difficulty = Number(radio_btn.value);
                break;
            }
        }
    }

    for (key in rounds_nodes) {
        if (rounds_nodes.hasOwnProperty(key)) {
            radio_btn = rounds_nodes[key];

            if (radio_btn.checked) {
                rounds = Number(radio_btn.value);
                break;
            }
        }
    }

    for (key in auto_hide_nodes) {
        if (auto_hide_nodes.hasOwnProperty(key)) {
            radio_btn = auto_hide_nodes[key];

            if (radio_btn.checked) {
                if (key === "auto-hide-0") {
                    auto_hide = null;
                } else {
                    auto_hide = Number(radio_btn.value);
                }
                break;
            }
        }
    }

    round = 0;
    score = 0;
    perfect_rounds = 0;
    memorization_times = [];
    intro_node.setAttribute("class", "screen");
    game_node.setAttribute("class", "screen active");
    prepare_next_round();

    return false;
}

function show_intro_screen()
{
    redraw_historical_scores();
    redraw_historical_times();
    end_node.setAttribute("class", "screen");
    intro_node.setAttribute("class", "screen active");
}

function redraw_historical_scores()
{
    var g = document.createElementNS("http://www.w3.org/2000/svg", "g"),
        history = stats_history.slice(Math.max(0, stats_history.length - 199)),
        x_offset,
        scores = [],
        rounds,
        score,
        rect,
        height,
        cls,
        min_score,
        max_score,
        scale,
        width, x_offset_delta,
        i, l;

    min_score = -1;
    max_score = 0.001;

    for (i = 0, l = history.length; i < l; ++i) {
        rounds = history[i][3];

        if (rounds < 1) {
            continue;
        }

        score = history[i][5] / rounds;
        scores.push([history[i][1], score]);

        if (score > max_score) {
            max_score = score;
        }

        if (min_score < 0 || score < min_score) {
            min_score = score;
        }
    }

    if (min_score < 0) {
        min_score = 0;
    }

    max_score = Math.max(1.0, Math.ceil(max_score * 1.05));
    min_score = Math.floor(min_score * 0.9);
    scale = 100.0 / (max_score - min_score);
    l = scores.length;
    width = (1 <= l) ? Math.max(2, Math.min(60, Math.floor(600 / l - 1))) : 60;
    x_offset_delta = width + 1;
    x_offset = 29 + 600 - l * x_offset_delta;

    width = String(width);

    for (i = 0; i < l; ++i) {
        score = scores[i];

        if (score[0] === MEDIUM) {
            cls = "medium";
        } else if (score[0] === HARD) {
            cls = "hard";
        } else {
            cls = "easy";
        }

        height = scale * (score[1] - min_score);
        rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("class", cls);
        rect.setAttribute("x", String(x_offset + i * x_offset_delta + 0.5));
        rect.setAttribute("width", width);
        rect.setAttribute("y", String(105 - height));
        rect.setAttribute("height", String(height));

        g.appendChild(rect);
    }

    stats_score_history_min_node.innerHTML = String(min_score);
    stats_score_history_mid_node.innerHTML = String(
        Math.round(50.0 * (max_score + min_score)) / 100.0
    );
    stats_score_history_max_node.innerHTML = String(max_score);

    stats_score_history_chart_node.innerHTML = "";
    stats_score_history_chart_node.appendChild(g);
}

function redraw_historical_times()
{
    var g = document.createElementNS("http://www.w3.org/2000/svg", "g"),
        history = stats_history.slice(Math.max(0, stats_history.length - 199)),
        x_offset,
        entry,
        times = [],
        rounds,
        time,
        obj,
        x_center,
        y_center,
        x,
        top_,
        bottom,
        height,
        cls,
        min_time,
        max_time,
        sd,
        scale,
        width,
        width_o2,
        width_o4,
        width_o8,
        width_str,
        width_o2_str,
        x_offset_delta,
        x_offset_delta_half,
        i, l;

    min_time = -1;
    max_time = 0.001;

    for (i = 0, l = history.length; i < l; ++i) {
        entry = history[i];

        if (entry[11] > max_time) {
            max_time = entry[11];
        }

        if (min_time < 0 || entry[10] < min_time) {
            min_time = entry[10];
        }

        sd = entry[8];
        min_time = Math.max(0.0, Math.min(entry[7] - sd, min_time));
        max_time = Math.max(entry[7] + sd, max_time);
    }

    if (min_time < 0) {
        min_time = 0;
    }

    max_time = Math.ceil(max_time * 10.5) / 10.0;
    min_time = Math.floor(min_time * 9.0) / 10.0;
    scale = 100.0 / (max_time - min_time);
    l = history.length;
    width = (1 <= l) ? Math.max(2, Math.min(60, Math.floor(600 / l - 1))) : 60;
    x_offset_delta = width + 1;
    x_offset = 29 + 600 - l * x_offset_delta;
    x_offset_delta_half = x_offset_delta / 2.0;

    width = Math.max(1.5, Math.min(10.0, width));
    width_o2 = width / 2.0;
    width_o4 = width / 4.0;
    width_o8 = width / 8.0;
    width_str = String(width);
    width_o2_str = String(width_o2);

    for (i = 0; i < l; ++i) {
        entry = history[i];

        if (entry[1] === MEDIUM) {
            cls = "medium";
        } else if (entry[1] === HARD) {
            cls = "hard";
        } else {
            cls = "easy";
        }

        bottom = 105 - scale * (entry[10] - min_time);
        top_ = 5 + scale * (max_time - entry[11]);
        height = bottom - top_;
        x_center = x_offset + i * x_offset_delta + x_offset_delta_half;
        y_center = (top_ + bottom) * 0.5;

        /* min - max line */
        obj = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        obj.setAttribute("class", cls);
        obj.setAttribute("x", String(x_center - 0.35));
        obj.setAttribute("width", "0.7");
        obj.setAttribute("y", String(top_));
        obj.setAttribute("height", String(height));
        g.appendChild(obj);

        /* max */
        x = String(x_center - width_o2);
        obj = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        obj.setAttribute("class", cls);
        obj.setAttribute("x", x);
        obj.setAttribute("width", width_str);
        obj.setAttribute("y", String(top_ - 0.6));
        obj.setAttribute("height", "1.2");
        g.appendChild(obj);

        /* min */
        obj = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        obj.setAttribute("class", cls);
        obj.setAttribute("x", x);
        obj.setAttribute("width", width_str);
        obj.setAttribute("y", String(bottom - 0.6));
        obj.setAttribute("height", "1.2");
        g.appendChild(obj);

        /* mean */
        y_center = 5 + scale * (max_time - entry[7]);
        obj = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        obj.setAttribute("class", cls);
        obj.setAttribute("x", String(x_center - width_o2));
        obj.setAttribute("width", width_str);
        obj.setAttribute("y", String(y_center - 0.6));
        obj.setAttribute("height", "1.2");
        g.appendChild(obj);

        /* standard deviation */
        sd = scale * entry[8];
        top_ = Math.max(5.0, y_center - sd);
        height = Math.min(105.0 - top_, 2.0 * sd);
        obj = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        obj.setAttribute("class", cls);
        obj.setAttribute("x", String(x_center - width_o4));
        obj.setAttribute("width", width_o2_str);
        obj.setAttribute("y", String(top_));
        obj.setAttribute("height", String(height));
        g.appendChild(obj);

        /* median */
        obj = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        obj.setAttribute("class", cls);
        obj.setAttribute("cx", String(x_center));
        obj.setAttribute("cy", String(5 + scale * (max_time - entry[9])));
        obj.setAttribute("r", width_o2);
        g.appendChild(obj);
    }

    stats_time_history_min_node.innerHTML = String(min_time);
    stats_time_history_mid_node.innerHTML = String(
        Math.round(50.0 * (max_time + min_time)) / 100.0
    );
    stats_time_history_max_node.innerHTML = String(max_time);

    stats_time_history_chart_node.innerHTML = "";
    stats_time_history_chart_node.appendChild(g);
}

function select()
{
    copy_text_node.select();
    copy_text_node.setSelectionRange(0, 99999);
}

function copy()
{
    select();
    navigator.clipboard.writeText(copy_text_node.value);
}

function init_audio()
{
    var partials = 24,
        soft_saw_coef = new Float32Array(partials),
        soft_sqr_coef = new Float32Array(partials),
        real = new Float32Array(partials),
        plus_or_minus_one, two_over_i_pi, softener,
        i, j;

    try {
        audio_ctx = new AudioContext();
    } catch (ex) {
        return;
    }

    soft_saw_coef[0] = 0.0;
    soft_sqr_coef[0] = 0.0;
    real[0] = 0.0;

    for (i = 0; i < partials; ++i) {
        j = i + 1;
        plus_or_minus_one = ((i & 1) == 1 ? -1.0 : 1.0);
        two_over_i_pi = 2.0 / (j * Math.PI);
        softener = 5.0 / (i + 5.0);

        soft_saw_coef[j] = softener * plus_or_minus_one * two_over_i_pi;
        soft_sqr_coef[j] = (
            softener * (1.0 + plus_or_minus_one) * two_over_i_pi
        );
        real[j] = 0.0;
    }

    win_lfo_amp_shaper_curve = new Float32Array(
        [1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0]
    );
    win_lfo_freq_shaper_curve = new Float32Array([0.0, win_frequency]);
    wrong_amp_curve = new Float32Array([-1.0, 1.0]);
    wrong_freq_curve = new Float32Array([0.0, wrong_frequency_1 * 2.5]);
    wrong_frequency_2 = wrong_frequency_1 * Math.pow(2.0, -19.0 / 12.0);

    soft_saw_wave = new PeriodicWave(
        audio_ctx,
        {
            "channelCount": 1,
            "disableNormalization": false,
            "real": real,
            "imag": soft_saw_coef
        }
    );
    soft_sqr_wave = new PeriodicWave(
        audio_ctx,
        {
            "channelCount": 1,
            "disableNormalization": false,
            "real": real,
            "imag": soft_sqr_coef
        }
    );

    audio_ctx.suspend();
    is_audio_suspended = true;
}

function restore_stats_history(data)
{
    var h = [], i, l, d, ex, min, max, rounds, auto_hide;

    try {
        data = JSON.parse(data);
    } catch (ex) {
        console.log("Error parsing historical statistics: " + ex);

        return [];
    }

    if (!(data && Array.isArray(data))) {
        console.log("No historical statistics found.");
        return [];
    }

    for (i = 0, l = data.length; i < l; ++i) {
        d = data[i];

        if (!(Array.isArray(d) && d.length === 12)) {
            console.log(
                "Ignoring invalid entry in historical statistics: wrong length;"
                + JSON.stringify(d)
            );

            continue;
        }

        try {
            rounds = validate_int(d[3], 5, 30);
            auto_hide = validate_number(d[4], 0.0, 8000.0);
            min = validate_number(d[10], 0.0, null);
            max = validate_number(d[11], min, null);

            h.push(
                [
                    validate_number(d[0], 0.0, null),       /* start */
                    validate_int(d[1], EASY, HARD),         /* difficulty */
                    validate_int(d[2], 3, 9),               /* numbers */
                    rounds,                                 /* rounds */
                    auto_hide,                              /* auto-hide */
                    validate_int(d[5], 0, null),            /* score */
                    validate_int(d[6], 0, rounds),          /* perfect rounds */
                    validate_number(d[7], min, max),        /* mean memorization time */
                    validate_number(d[8], 0.0, max - min),  /* standard deviation */
                    validate_number(d[9], min, max),        /* median memorization time */
                    min,                                    /* fastest memorization time */
                    max                                     /* slowest memorization time */
                ]
            );
        } catch (ex) {
            console.log(
                "Ignoring invalid entry in historical statistics: "
                + String(ex)
                + "; "
                + JSON.stringify(d)
            );
        }
    }

    return truncate_stats_history(h);
}

function truncate_stats_history(h)
{
    if (h.length > STATS_HISTORY_MAX_LENGTH) {
        return h.slice(h.length - STATS_HISTORY_MAX_LENGTH);
    }

    return h;
}

function validate_int(num, min, max)
{
    return validate_number(num, min, max, 0.0) | 0;
}

function validate_number(raw_num, min, max, tolerance)
{
    var num = Number(raw_num);

    tolerance = tolerance || 0.000001;

    if (max !== null && num > (max + tolerance)) {
        throw "Value " + String(raw_num) + " greater than " + String(max);
    }

    if (min !== null && num < (min - tolerance)) {
        throw "Value " + String(raw_num) + " less than " + String(min);
    }

    return num;
}

function export_stats_history(evt)
{
    var lines = [],
        d = new Date(),
        ds, m, i, l, s;

    function format_time(t)
    {
        return (t < 10) ? "0" + String(t) : String(t);
    }

    lines.push(
        [
            "Game Start",
            "Difficulty",
            "Numbers",
            "Rounds",
            "Auto-hide",
            "Score",
            "Perfect Rounds",
            "Mean Memorization Time",
            "Standard Deviation",
            "Median Memorization Time",
            "Fastest Memorization Time",
            "Slowest Memorization Time"
        ].join("\t")
    );

    for (i = 0, l = stats_history.length; i < l; ++i) {
        s = stats_history[i];
        d.setTime(s[0] * 1000.0);
        ds = [
            String(d.getFullYear()),
            "-",
            format_time(d.getMonth() + 1),
            "-",
            format_time(d.getDate()),
            " ",
            format_time(d.getHours()),
            ":",
            format_time(d.getMinutes()),
            ":",
            format_time(d.getSeconds())
        ].join("");

        lines.push(
            [
                ds,
                String(s[1]),
                String(s[2]),
                String(s[3]),
                String(s[4] / 1000.0),
                String(s[5]),
                String(s[6]),
                String(s[7]),
                String(s[8]),
                String(s[9]),
                String(s[10]),
                String(s[11])
            ].join("\t")
        );
    }

    stats_history_save_node.href = URL.createObjectURL(
        new Blob([lines.join("\r\n")], {"type": "text/tab-separated-values"})
    );
    stats_history_save_node.save = "chimp-mem-game.tsv";

    return true;
}

function main()
{
    var game = $("game"),
        body = document.getElementsByTagName("body")[0],
        i, key, card_node;

    stats_history = restore_stats_history(
        localStorage.getItem(LOCAL_STORAGE_KEY)
    );

    for (i = 3; i < 10; ++i) {
        key = "cards-" + String(i);
        card_num_nodes[key] = $(key);
    }

    for (i = 1; i < 4; ++i) {
        key = "difficulty-" + String(i);
        difficulty_nodes[key] = $(key);
    }

    for (i = 0; i < 5; ++i) {
        key = "rounds-" + String(i);
        rounds_nodes[key] = $(key);
    }

    for (i = 0; i < 15; ++i) {
        key = "auto-hide-" + String(i);
        auto_hide_nodes[key] = $(key);
    }

    start_round_btn_node = $("start-round");
    mute_node = $("mute");
    copy_text_node = $("copy-text");
    tweet_node = $("tweet");
    stats_round_node = $("stats-rounds");
    stats_score_node = $("stats-score");
    stats_perfect_rounds_node = $("stats-perfect-rounds");
    game_node = game;
    end_node = $("end");
    intro_node = $("intro");
    stats_history_save_node = $("stats-history-save");
    stats_score_history_chart_node = $("stats-history-score-chart");
    stats_score_history_min_node = $("stats-history-score-min");
    stats_score_history_mid_node = $("stats-history-score-mid");
    stats_score_history_max_node = $("stats-history-score-max");
    stats_time_history_chart_node = $("stats-history-time-chart");
    stats_time_history_min_node = $("stats-history-time-min");
    stats_time_history_mid_node = $("stats-history-time-mid");
    stats_time_history_max_node = $("stats-history-time-max");
    stats_mem_time_mean_node = $("stats-mem-time-mean");
    stats_mem_time_min_node = $("stats-mem-time-min");
    stats_mem_time_max_node = $("stats-mem-time-max");
    stats_mem_time_median_node = $("stats-mem-time-median");
    stats_mem_time_sd_node = $("stats-mem-time-sd");
    status_text_node = $("status-text");

    for (i = 0; i < CARDS; ++i) {
        card_node = document.createElement("div");
        card_node.setAttribute("class", "card hidden");
        card_node.setAttribute("id", "card-" + String(i));
        card_nodes.push(card_node);
        game.appendChild(card_node);
    }

    body.addEventListener("mousedown", handle_card_touch, false);
    $("form").addEventListener(
        "submit",
        function (evt)
        {
            evt = evt || window.event;
            evt.stopPropagation();
            evt.preventDefault();
            return false;
        }
    );
    $("start").addEventListener("click", start_game);
    $("restart").addEventListener("click", show_intro_screen);
    start_round_btn_node.addEventListener("click", start_round);
    copy_text_node.addEventListener("click", select);
    $("copy-button").addEventListener("click", copy);

    stats_history_save_node.addEventListener("click", export_stats_history);

    show_intro_screen();
}

window.onload = main;

})();

//-->
</script>
</body>
</html>
