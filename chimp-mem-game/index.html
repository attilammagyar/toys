<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <title>Chimp Memory Game</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Test your short term memory: can you beat the results of the chimps in the Primate Research Institute in Inuyama, Japan?" />

  <meta name="twitter:card" content="summary" />
  <meta property="og:title" content="Chimp Memory Game" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://attilammagyar.github.io/toys/chimp-mem-game" />
  <meta property="og:image" content="https://attilammagyar.github.io/toys/chimp-mem-game/chimp-mem-game.jpg" />
  <meta property="og:image:alt" content="Screenshot of the game" />
  <meta property="og:image:width" content="1280" />
  <meta property="og:image:height" content="720" />
  <meta property="og:description" content="Test your short term memory: can you beat the results of the chimps in the Primate Research Institute in Inuyama, Japan?" />

<style>
* {
  font-family: Verdana, sans-serif;
  color: #bbc;
  margin: 0;
  padding: 0;
}

html, body {
  background-color: #000000;
  width: 100vw;
}

div.screen {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  transition: opacity 0.4s ease-in-out;
  height: 1vmin;
  overflow: hidden;
  width: 100vw;
  z-index: 0;
}

div.screen.active {
  opacity: 1;
  z-index: 10;
  height: 99vh;
  overflow: visible;
}

div.card {
  display: inline-block;
  width: 10vw;
  height: 16vh;
  margin: 0.75vh 0.75vw;
  font-size: 12vh;
  line-height: 16vh;
  font-weight: bold;
  text-align: center;
  cursor: pointer;
  transition: color 0.1s ease-in-out, background-color 0.1s ease-in-out;
  border-radius: 1vmin;
  z-index: 15;
}

div.card.revealed {
  color: rgba(208, 208, 222, 1);
  background-color: #000;
}

div.card.hidden {
  color: rgba(0, 0, 0, 0);
  background-color: #000;
}

div.card.wrong {
  background-color: #800000;
}

div.card.expected {
  background-color: #007000;
}

div.card.value_hidden {
  color: rgba(112, 112, 122, 0);
  background-color: #70707a;
}

#status {
  height: 10vh;
  line-height: 10vh;
  font-size: 3.3vh;
  color: red;
  padding: 0 3vw 0 0;
  text-align: right;
}

div.settings {
  margin-top: 2vh;
  text-align: center;
}

div.options {
  display: inline-block;
  height: 2.8vmax;
  margin: 0 0 0.2vmax 0;
  padding: 0;
  text-align: center;
}

div.options div {
  display: inline-block;
  margin: 0;
  padding: 0;
}

div.options label {
  cursor: pointer;
  display: block;
  height: 2.8vmax;
  line-height: 2.8vmax;
  font-size: 2.2vmax;
  margin: 0.05vmax;
  border: solid 0.3vmax #bbc;
  border-radius: 12vmax;
  background-color: #000;
}

div.cards label,
div.rounds label {
  width: 5vmax;
}

div.difficulty label {
  width: 15vmax;
}

div.auto-hide label {
  width: 7.2vmax;
}

div.settings input[type="radio"] {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  width: 0;
  height: 0;
}

div.settings input[type="radio"]:checked + label {
  background-color: #bbc;
  color: #000;
}

button {
  cursor: pointer;
  height: 8vmax;
  width: 42vmax;
  font-weight: bold;
  border: outset 0.5vmax #bbc;
  border-radius: 15vmax;
  font-size: 3.2vmax;
  line-height: 3.2vmax;
  background-color: #000;
}

#sound-settings {
  position: absolute;
  top: 0;
  left: 0;
  height: 10vh;
  line-height: 10vh;
  z-index: 20;
}

#sound-settings input[type="checkbox"],
#status input[type="checkbox"] {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  width: 0;
  height: 0;
}

#status label img,
#sound-settings label svg {
  cursor: pointer;
  padding-top: 1.6vh;
  margin-left: 1vmin;
  height: 7vh;
  width: 7vh;
}

#sound-settings input[type="checkbox"]:checked + label #sound-on {
  display: none;
}

#sound-settings input[type="checkbox"]:not(:checked) + label #sound-on {
  display: auto;
}

#sound-settings input[type="checkbox"]:checked + label #sound-off {
  display: auto;
}

#sound-settings input[type="checkbox"]:not(:checked) + label #sound-off {
  display: none;
}

@media only screen and (orientation: portrait) {
  div.card {
    display: inline-block;
    width: 16vw;
    height: 9.5vh;
    margin: 0.75vh 0.75vw;
    font-size: 7vh;
    line-height: 10vh;
  }
}

.screen h1,
.screen p {
  text-align: center;
  margin: 3vmin auto 2vmin auto;
  width: 80vw;
}

.screen h1 {
  font-size: 3.2vmax;
}

.screen p {
  font-size: 2.2vmax;
  line-height: 3.6vmax;
}

.screen p a {
  color: #8787ff;
  font-weight: bold;
}

#statistics {
  margin: auto;
}

#statistics tr th,
#statistics tr td {
  font-weight: normal;
  font-size: 2.5vmax;
  min-width: 20vw;
}

#statistics th {
  text-align: left;
}

#statistics tr {
  text-align: right;
}

#copy-button,
#tweet {
  cursor: pointer;
  display: inline-block;
  height: 5vmax;
  width: 32vmax;
  margin: 0.5vmax;
  font-weight: normal;
  border: outset 0.3vmax #bbc;
  border-radius: 15vmax;
  font-size: 2.5vmax;
  line-height: 5vmax;
  background-color: #000;
}

#start-round {
  display: none;
  width: 0;
  height: 0;
  border-radius: 10vh;
  border: outset 1vmax #bbc;
  cursor: pointer;
  font-weight: bold;
  font-size: 7vh;
  line-height: 7vh;
  background-color: #000;
}

#start-round.visible {
  display: block;
  position: absolute;
  width: 80vw;
  height: 20vh;
  bottom: 10vh;
  left: 10vw;
  z-index: 30;
}

#copy-text {
  margin: 2vmin;
  font-size: 2vmax;
  width: 70vw;
  height: 20vh;
  background-color: #000;
  color: #bbc;
  border-radius: 1vmax;
  border: inset 0.3vmax #bbc;
  padding: 0.3vmax;
}

</style>
</head>
<body>
  <form id="form" action="#" method="get">
    <div>
      <audio id="audio-click" preload="auto">
        <source src="click.ogg" type="audio/ogg" />
        <source src="click.mp3" type="audio/mpeg" />
      </audio>
      <audio id="audio-wrong" preload="auto">
        <source src="wrong.ogg" type="audio/ogg" />
        <source src="wrong.mp3" type="audio/mpeg" />
      </audio>
      <audio id="audio-win" preload="auto">
        <source src="win.ogg" type="audio/ogg" />
        <source src="win.mp3" type="audio/mpeg" />
      </audio>
    </div>
    <div id="intro" class="screen active">
      <h1>Chimp Memory Game</h1>
      <div class="settings">
        <p>How many numbers do you want to memorize?</p>
        <div class="options">
          <div class="cards">
            <input type="radio" id="cards-3" name="cards" value="3" />
            <label for="cards-3">3</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-4" name="cards" value="4" />
            <label for="cards-4">4</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-5" name="cards" value="5" checked="checked" />
            <label for="cards-5">5</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-6" name="cards" value="6" />
            <label for="cards-6">6</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-7" name="cards" value="7" />
            <label for="cards-7">7</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-8" name="cards" value="8" />
            <label for="cards-8">8</label>
          </div>
          <div class="cards">
            <input type="radio" id="cards-9" name="cards" value="9" />
            <label for="cards-9">9</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Select the difficulty level:</p>
        <div class="options">
          <div class="difficulty">
            <input type="radio" id="difficulty-1" name="difficulty" value="1" checked="checked" />
            <label for="difficulty-1">Easy</label>
          </div>
          <div class="difficulty">
            <input type="radio" id="difficulty-2" name="difficulty" value="2" />
            <label for="difficulty-2">Medium</label>
          </div>
          <div class="difficulty">
            <input type="radio" id="difficulty-3" name="difficulty" value="3" />
            <label for="difficulty-3">Hard</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Number of rounds:</p>
        <div class="options">
          <div class="rounds">
            <input type="radio" id="rounds-0" name="rounds" value="5" />
            <label for="rounds-0">5</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-1" name="rounds" value="10" checked="checked" />
            <label for="rounds-1">10</label>
          </div>
          <div class="rounds">
            <input type="radio" id="rounds-2" name="rounds" value="20" />
            <label for="rounds-2">20</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <p>Auto-hide numbers:</p>
        <div class="options">
          <div class="auto-hide">
            <input type="radio" id="auto-hide-0" name="auto-hide" value="off" checked="checked" />
            <label for="auto-hide-0">Off</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-1" name="auto-hide" value="210" />
            <label for="auto-hide-1">.21s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-2" name="auto-hide" value="430" />
            <label for="auto-hide-2">.43s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-3" name="auto-hide" value="650" />
            <label for="auto-hide-3">.65s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-4" name="auto-hide" value="1000" />
            <label for="auto-hide-4">1s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-5" name="auto-hide" value="2000" />
            <label for="auto-hide-5">2s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-6" name="auto-hide" value="4000" />
            <label for="auto-hide-6">4s</label>
          </div>
          <div class="auto-hide">
            <input type="radio" id="auto-hide-7" name="auto-hide" value="8000" />
            <label for="auto-hide-7">8s</label>
          </div>
        </div>
      </div>
      <div class="settings">
        <button id="start" type="submit">Start Game!</button>
      </div>
      <p>
        Test your short term memory: can you beat the results of the
        chimps in the
        <a href="https://en.wikipedia.org/wiki/Primate_Research_Institute"
          target="_blank">Primate Research Institute</a> in Inuyama, Japan?
        Memorize the randomly scattered numbers, then click or touch
        them in ascending order - if you can.
      </p>
      <p>
        This game is a clone of the memory test shown in
        <a href="https://www.youtube.com/watch?v=ktkjUjcZid0"
          target="_blank">Mindfield S03E01: The Cognitive Tradeoff Hypothesis (24:21)</a>
        and in <a href="https://www.youtube.com/watch?v=zsXP8qeFF6A"
          target="_blank">this video from BBC Earth (3:42)</a>.
      </p>
      <p>
        <a href="https://github.com/attilammagyar/toys"
          target="_blank">Source code on GitHub</a>
      </p>
      <p>
        (By the way, this website doesn't use any cookies.)
      </p>
    </div>
    <div id="game" class="screen">
      <div id="sound-settings">
        <input type="checkbox" id="mute" name="mute" checked="checked" />
        <label for="mute">
          <svg id="sound-on" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
           <g>
            <title>Sound: ON</title>
            <path stroke="#d0d0de" id="svg_10" d="m72.5,186.90556l0,131.80502l70.71604,0l105.86168,92.24348l0.06293,-316.29197l-105.87741,92.24348l-70.76324,0zm217.22961,-15.15691c-6.18274,-6.49343 -16.10973,-6.49343 -22.261,0.03339c-6.13554,6.52682 -6.13554,17.09325 0.03146,23.63677l0,-0.03339c13.57685,14.42243 21.94636,34.2032 21.94636,56.1874c0,21.9675 -8.35377,41.6815 -21.91489,56.10393c-6.19847,6.49343 -6.19847,17.05987 -0.03146,23.62007c3.06777,3.25506 7.0952,4.89094 11.12263,4.89094c4.04316,0 8.0706,-1.63588 11.13837,-4.89094c19.22469,-20.36501 31.14967,-48.65902 31.13394,-79.72401c0.01573,-31.13176 -11.95644,-59.45915 -31.1654,-79.82416zm36.1053,-38.2929c-6.18274,-6.52682 -16.10973,-6.52682 -22.22954,0c-6.16701,6.52682 -6.16701,17.10995 0,23.60338c22.81163,24.22101 36.87617,57.5395 36.87617,94.49698c0,36.9241 -14.06455,70.2259 -36.84471,94.4636c-6.16701,6.51013 -6.16701,17.07656 0,23.60338c3.06777,3.25506 7.0952,4.89094 11.13837,4.89094c4.02743,0 8.05486,-1.63588 11.12263,-4.89094c28.44374,-30.19697 46.07949,-72.0287 46.04802,-118.06698c0.01573,-46.07166 -17.62001,-87.93678 -46.11095,-118.10037zm34.28037,-36.37324c-6.18274,-6.52682 -16.12546,-6.49343 -22.24527,0.03339c-6.15127,6.49343 -6.15127,17.07656 0.03146,23.58669l-0.03146,0c31.6059,33.5355 51.09804,79.67393 51.09804,130.85354c0,51.12953 -19.49214,97.28465 -51.06658,130.83684c-6.15127,6.51013 -6.15127,17.07656 0.03146,23.62007c3.05204,3.23837 7.07947,4.85756 11.1069,4.85756s8.0706,-1.63588 11.13837,-4.89094c37.17509,-39.49477 60.26989,-94.19652 60.23843,-154.42353c0.03146,-60.27709 -23.06334,-114.99554 -60.30135,-154.47361z" stroke-width="6" fill="#d0d0de"/>
           </g>
          </svg>
          <svg id="sound-off" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
           <g>
            <title>Sound: OFF</title>
            <path stroke="#d0d0de" id="svg_10" d="m72.5,186.90556l0,131.80502l70.71604,0l105.86168,92.24348l0.06293,-316.29197l-105.87741,92.24348l-70.76324,0z" stroke-width="6" fill="#4c4c51"/>
            <rect transform="rotate(45 250 255)" id="svg_11" height="560" width="50" y="-25.00034" x="225" stroke-width="6" stroke="#d0d0de" fill="#d0d0de"/>
           </g>
          </svg>
        </label>
      </div>
      <div id="status">
        <span id="status-text"></span>
      </div>
      <button id="start-round">
        Start
      </button>
    </div>
    <div id="end" class="screen">
      <h1>Statistics</h1>
      <table id="statistics">
        <tr><th>Score:</th><td id="stats-score"></td></tr>
        <tr><th>Rounds:</th><td id="stats-rounds"></td></tr>
        <tr><th>Perfect rounds:</th><td id="stats-perfect-rounds"></td></tr>
        <tr><th>Mean memorization time:</th><td id="stats-mem-time-mean"></td></tr>
        <tr><th>Standard deviation:</th><td id="stats-mem-time-sd"></td></tr>
        <tr><th>Median memorization time:</th><td id="stats-mem-time-median"></td></tr>
        <tr><th>Fastest memorization time:</th><td id="stats-mem-time-min"></td></tr>
        <tr><th>Slowest memorization time:</th><td id="stats-mem-time-max"></td></tr>
      </table>
      <div class="settings">
        <a id="copy-button">Copy to clipboard</a>
        <a id="tweet" href="#" target="_blank">Share on Twitter</a>
        <br/>
        <textarea id="copy-text" name="copy-text" rows="3" cols="70" readonly="readonly"></textarea>
      </div>
      <div class="settings">
        <button id="restart">New Game</button>
      </div>
    </div>
  </form>
<script type="text/javascript">
<!--
(function () {

"use strict";

function $(id) { return document.getElementById(id); }

var CTH = {
    CARDS: 40,

    EASY: 1,
    MEDIUM: 2,
    HARD: 3,

    URL: "https://attilammagyar.github.io/toys/chimp-mem-game",
    SHARE_TEXT: "I just scored {score} in the Chimp Memorization Game on {difficulty} difficulty with {numbers} numbers in {rounds} rounds.",
    SHARE_STATS: " My fastest memorization time was {min}s (mean: {mean}s, median: {median}s, standard deviation: {sd}s).",
    SHARE_AUTO_HIDE: " The numbers were automatically hidden after {auto-hide}s.",
    SHARE_PERFECT_ROUNDS: " I had {perfect_rounds}.",
    SHARE_HASHTAGS: " #MindField",

    start_round_btn_node: null,
    mute_node: null,
    audio_nodes: null,
    tweet_node: null,
    copy_text_node: null,
    stats_round_node: null,
    stats_score_node: null,
    stats_perfect_rounds_node: null,
    game_node: null,
    end_node: null,
    intro_node: null,
    stats_mem_time_mean_node: null,
    stats_mem_time_min_node: null,
    stats_mem_time_max_node: null,
    stats_mem_time_median_node: null,
    stats_mem_time_sd_node: null,
    status_text_node: null,
    card_num_nodes: {},
    difficulty_nodes: {},
    rounds_nodes: {},
    auto_hide_nodes: {},
    numbers: 3,
    rounds: 10,
    card_nodes: [],
    card_values: [],
    expected_values: [],
    done_memorizing: false,
    accept_card_touches: false,
    difficulty: 0,
    auto_hide: null,
    round: 0,
    score: 0,
    perfect_rounds: 0,
    memorization_times: [],
    memorization_start: 0,
    hiding_timer: null,
    audio_ctx: null,
    soft_saw_wave: null,
    soft_sqr_wave: null,
    win_frequency: 1108.73,
    win_lfo_freq_shaper_curve: null,
    win_lfo_amp_shaper_curve: null,
    wrong_frequency_1: 311.13,
    wrong_frequency_2: null,
    wrong_freq_curve: null,
    wrong_amp_curve: null,

    now: function ()
    {
        return (new Date()).getTime() / 1000;
    },

    format_stats: function (n)
    {
        return String(Math.round(n * 100) / 100);
    },

    statistics: function (arr)
    {
        var l = arr.length,
            mean, sd, median, sum, i, m, d;

        if (l < 1) {
            return {
                "valid": false,
                "min": "?",
                "max": "?",
                "mean": "?",
                "median": "?",
                "sd": "?"
            };
        }

        arr.sort(function (a, b) { return a - b; });

        for (i = 0, sum = 0; i < l; ++i) {
            sum += arr[i];
        }

        mean = sum / l;

        for (i = 0, sum = 0; i < l; ++i) {
            d = arr[i] - mean;
            sum += d * d;
        }

        sd = Math.sqrt(sum / l);

        m = Math.floor(l / 2);

        if (l % 2 == 0) {
            median = (arr[m - 1] + arr[m]) / 2;
        } else {
            median = arr[m];
        }

        return {
            "valid": true,
            "min": CTH.format_stats(arr[0]),
            "max": CTH.format_stats(arr[l - 1]),
            "mean": CTH.format_stats(mean),
            "median": CTH.format_stats(median),
            "sd": CTH.format_stats(sd)
        };
    },

    clear_selection: function ()
    {
        try {
            window.getSelection().removeAllRanges();
        } catch (ex) {}
    },

    update_status: function ()
    {
        CTH.status_text_node.innerHTML = (
            "Score: " + String(CTH.score)
            + " (Round " + String(CTH.round) + "/" + String(CTH.rounds) + ")"
        );
    },

    play_audio: function (id)
    {
        var ex, audio;

        try {
            if (!CTH.mute_node.checked) {
                audio = CTH.audio_nodes[id];
                audio.pause();
                audio.currentTime = 0;
                audio.play();
            }
        } catch (ex) {
        }
    },

    is_mute: function ()
    {
        return CTH.mute_node.checked || CTH.audio_ctx === null;
    },

    play_click_sound: function ()
    {
        var osc, gain_env, start, ac;

        if (CTH.is_mute()) {
            return;
        }

        ac = CTH.audio_ctx;

        osc = new OscillatorNode(ac, {"channelCount": 1});
        gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});

        start = ac.currentTime + 0.05;

        CTH.start_envelope(gain_env, start, 0.002, 0.005, 0.02);

        osc.type = "square";
        osc.frequency.value = 660.0;

        osc.connect(gain_env);
        gain_env.connect(ac.destination);

        osc.start(start);

        setTimeout(
            function ()
            {
                gain_env.disconnect(ac.destination);
                osc.disconnect(gain_env);
            },
            300
        );
    },

    start_envelope: function (gain_env, time, attack, hold, decay)
    {
        gain_env.gain.setValueAtTime(0.0, time);

        time += attack;
        gain_env.gain.linearRampToValueAtTime(0.5, time);

        time += hold;
        gain_env.gain.setValueAtTime(0.5, time);

        time += decay;
        gain_env.gain.linearRampToValueAtTime(0.0, time);
    },

    play_win_sound: function ()
    {
        var osc, gain_env, gain_amp,
            lfo_freq, lfo_freq_shaper,
            lfo_amp, lfo_amp_shaper,
            start, ac;

        if (CTH.is_mute()) {
            return;
        }

        ac = CTH.audio_ctx;

        osc = new OscillatorNode(
            ac,
            {
                "channelCount": 1,
                "type": "sine",
                "frequency": CTH.win_frequency
            }
        );
        gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
        gain_amp = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
        lfo_freq = new OscillatorNode(
            ac,
            {
                "channelCount": 1,
                "periodicWave": CTH.soft_saw_wave,
                "frequency": 12.0
            }
        );
        lfo_freq_shaper = new WaveShaperNode(
            ac, {"channelCount": 1, "curve": CTH.win_lfo_freq_shaper_curve}
        );
        lfo_amp = new OscillatorNode(
            ac, {"channelCount": 1, "type": "triangle", "frequency": 6.0}
        );
        lfo_amp_shaper = new WaveShaperNode(
            ac, {"channelCount": 1, "curve": CTH.win_lfo_amp_shaper_curve}
        );

        start = ac.currentTime + 0.05;

        CTH.start_envelope(gain_env, start, 0.03, 1.2, 0.05);

        osc.connect(gain_amp);
        gain_amp.connect(gain_env);
        gain_env.connect(ac.destination);

        lfo_freq.connect(lfo_freq_shaper);
        lfo_freq_shaper.connect(osc.frequency);

        lfo_amp.connect(lfo_amp_shaper);
        lfo_amp_shaper.connect(gain_amp.gain);

        lfo_freq.start(start);
        lfo_amp.start(start);
        osc.start(start);

        setTimeout(
            function ()
            {
                gain_env.disconnect(ac.destination);
                gain_amp.disconnect(gain_env);
                osc.disconnect(gain_amp);
                lfo_freq_shaper.disconnect(osc.frequency);
                lfo_freq.disconnect(lfo_freq_shaper);
                lfo_amp_shaper.disconnect(gain_amp.gain);
                lfo_amp.disconnect(lfo_amp_shaper);
            },
            2000
        );
    },

    play_wrong_sound: function ()
    {
        var modulator, carrier,
            amp_shaper, freq_shaper,
            gain_env, gain_amp,
            start, ac;

        if (CTH.is_mute()) {
            return;
        }

        ac = CTH.audio_ctx;

        carrier = new OscillatorNode(
            ac,
            {
                "channelCount": 1,
                "periodicWave": CTH.soft_saw_wave,
                "frequency": CTH.wrong_frequency_1
            }
        );
        modulator = new OscillatorNode(
            ac,
            {
                "channelCount": 1,
                "periodicWave": CTH.soft_sqr_wave,
                "frequency": CTH.wrong_frequency_2
            }
        );
        gain_env = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
        gain_amp = new GainNode(ac, {"channelCount": 1, "gain": 0.0});
        amp_shaper = new WaveShaperNode(
            ac, {"channelCount": 1, "curve": CTH.wrong_amp_curve}
        );
        freq_shaper = new WaveShaperNode(
            ac, {"channelCount": 1, "curve": CTH.wrong_freq_curve}
        );

        start = ac.currentTime + 0.05;

        CTH.start_envelope(gain_env, start, 0.003, 0.6, 0.03);

        modulator.connect(amp_shaper);
        amp_shaper.connect(gain_amp.gain);

        modulator.connect(freq_shaper);
        freq_shaper.connect(carrier.frequency);

        carrier.connect(gain_amp);
        gain_amp.connect(gain_env);
        gain_env.connect(ac.destination);

        modulator.start(start);
        carrier.start(start);

        setTimeout(
            function ()
            {
                gain_env.disconnect(ac.destination);
                gain_amp.disconnect(gain_env);
                carrier.disconnect(gain_amp);
                modulator.disconnect(amp_shaper);
                amp_shaper.disconnect(gain_amp.gain);
                modulator.disconnect(freq_shaper);
                freq_shaper.disconnect(carrier.frequency);
            },
            2000
        );
    },

    handle_wrong_card: function (clicked_card_index, expected_value)
    {
        var i;

        CTH.reveal_cards();

        for (i = 0; i < CTH.CARDS; ++i) {
            if (CTH.card_values[i] == expected_value) {
                CTH.card_nodes[i].setAttribute("class", "card revealed expected");
            } else if (CTH.card_values[i]) {
                CTH.card_nodes[i].setAttribute("class", "card revealed");
            }
        }
        CTH.card_nodes[clicked_card_index].setAttribute("class", "card revealed wrong");
        CTH.play_wrong_sound();

        setTimeout(CTH.prepare_next_round, 1000);
    },

    handle_perfect_round: function ()
    {
        CTH.play_win_sound();
        CTH.prepare_next_round();
        ++CTH.perfect_rounds;
    },

    handle_card_touch: function (evt)
    {
        var now = CTH.now(),
            clicked_card_index, card_value, card_node;

        if (!CTH.accept_card_touches) {
            CTH.clear_selection();
            return;
        }

        CTH.accept_card_touches = false;

        clicked_card_index = evt.target.getAttribute("id").match(/^card-([0-9]+)$/);

        if (!clicked_card_index) {
            CTH.accept_card_touches = true;
            return;
        }

        evt.stopPropagation();
        evt.preventDefault();
        CTH.clear_selection();

        clicked_card_index = Number(clicked_card_index[1]);
        card_node = CTH.card_nodes[clicked_card_index];

        if (!card_node) {
            CTH.accept_card_touches = true;
            return;
        }

        if (CTH.done_memorizing && card_node.getAttribute("class").match(/revealed/)) {
            CTH.accept_card_touches = true;
            return;
        }

        card_value = Number(CTH.card_values[clicked_card_index]);

        if (CTH.difficulty == CTH.EASY && !card_value) {
            CTH.accept_card_touches = true;
            return;
        }

        if (card_value != CTH.expected_values[0]) {
            CTH.handle_wrong_card(clicked_card_index, CTH.expected_values[0]);
            return;
        }

        CTH.play_click_sound();

        CTH.expected_values = CTH.expected_values.slice(1);
        CTH.score += CTH.difficulty * (CTH.numbers - CTH.expected_values.length);
        CTH.update_status();

        if (!CTH.done_memorizing) {
            CTH.done_memorizing = true;
            if (CTH.auto_hide <= 0) {
                CTH.memorization_times.push(now - CTH.memorization_start);
            } else {
                CTH.memorization_times.push(CTH.auto_hide / 1000);
            }
            CTH.hide_card_values();
        }

        CTH.reveal_card(clicked_card_index);
        card_node.setAttribute("class", "card revealed");

        if (CTH.expected_values.length === 0) {
            CTH.handle_perfect_round();
            return
        }

        CTH.accept_card_touches = true;

        return false;
    },

    randomize_card_values: function ()
    {
        var i,
            expected_values = [1, 2, 3, 4, 5, 6, 7, 8, 9];

        CTH.shuffle(expected_values);
        expected_values = expected_values.slice(0, CTH.numbers);
        expected_values.sort(function (a, b) { return a-b; });
        CTH.expected_values = expected_values;

        CTH.card_values = [];

        for (i = 0; i < CTH.CARDS; ++i) {
            CTH.card_values.push(i < CTH.numbers ? String(expected_values[i]) : "");
        }

        CTH.shuffle(CTH.card_values);
    },

    shuffle: function (arr)
    {
        var i, j, tmp, l = arr.length;

        for (i = l - 1; i > 0; --i) {
            j = Math.floor(Math.random() * l);
            tmp = arr[i];
            arr[i] = arr[j];
            arr[j] = tmp;
        }
    },

    reveal_cards: function ()
    {
        var i;

        for (i = 0; i < CTH.CARDS; ++i) {
            CTH.reveal_card(i);
        }
    },

    hide_cards: function ()
    {
        var i, card_node;

        for (i = 0; i < CTH.CARDS; ++i) {
            card_node = CTH.card_nodes[i];
            card_node.setAttribute("class", "card hidden");
            card_node.innerHTML = "&nbsp;";
        }
    },

    hide_card_values: function ()
    {
        var i;

        if (CTH.hiding_timer !== null) {
            clearTimeout(CTH.hiding_timer);
            CTH.hiding_timer = null;
        }

        for (i = 0; i < CTH.CARDS; ++i) {
            CTH.hide_card_value(i);
        }
    },

    hide_card_value: function (i)
    {
        var card_node = CTH.card_nodes[i];

        card_node.innerHTML = "&nbsp;";

        switch (CTH.difficulty) {
            case CTH.EASY:
                if (CTH.card_values[i]) {
                    card_node.setAttribute("class", "card value_hidden");
                } else {
                    card_node.setAttribute("class", "card hidden");
                }
                break;
            case CTH.MEDIUM:
            case CTH.HARD:
                card_node.setAttribute("class", "card value_hidden");
                break;
            default:
                card_node.setAttribute("class", "card hidden");
        }
    },

    reveal_card: function (i)
    {
        var card_node = CTH.card_nodes[i],
            value = CTH.card_values[i];

        card_node.innerHTML = value ? value : "&nbsp;";

        if (CTH.difficulty === CTH.MEDIUM) {
            if (value) {
                card_node.setAttribute("class", "card revealed");
            } else {
                card_node.setAttribute("class", "card value_hidden");
            }
        } else {
            card_node.setAttribute("class", "card revealed");
        }
    },

    prepare_next_round: function ()
    {
        ++CTH.round;
        CTH.accept_card_touches = false;

        if (CTH.auto_hide > 0) {
            CTH.start_round_btn_node.setAttribute("class", "");
        }

        if (CTH.round <= CTH.rounds) {
            setTimeout(function () {
                CTH.hide_cards();
                CTH.update_status();
                if (CTH.auto_hide > 0) {
                    setTimeout(CTH.prepare_round, 500);
                } else {
                    setTimeout(CTH.start_round, 500);
                }
            }, 500);
        } else {
            setTimeout(CTH.show_end_screen, 1000);
        }
    },

    prepare_round: function ()
    {
        CTH.start_round_btn_node.setAttribute("class", "visible");
    },

    start_round: function ()
    {
        CTH.start_round_btn_node.setAttribute("class", "");
        CTH.randomize_card_values();
        CTH.reveal_cards();
        CTH.accept_card_touches = true;
        CTH.done_memorizing = false;
        CTH.memorization_start = CTH.now();

        if (CTH.auto_hide > 0) {
            CTH.hiding_timer = setTimeout(CTH.hide_card_values, CTH.auto_hide);
        }
    },

    format_number_with_units: function (n, unit)
    {
        if (n == 1) {
            return String(n) + " " + unit;
        }

        return String(n) + " " + unit + "s";
    },

    show_end_screen: function ()
    {
        var difficulty = ["easy", "medium", "hard"][CTH.difficulty - 1],
            stats = CTH.statistics(CTH.memorization_times),
            share_text;

        CTH.hide_cards();

        share_text = (
            CTH.SHARE_TEXT
                .replace("{score}", CTH.format_number_with_units(CTH.score, "point"))
                .replace("{numbers}", String(CTH.numbers))
                .replace("{difficulty}", difficulty)
                .replace("{rounds}", CTH.rounds)
        );

        if (CTH.auto_hide > 0) {
            share_text += (
                CTH.SHARE_AUTO_HIDE
                    .replace(
                        "{auto-hide}",
                        CTH.format_stats(CTH.auto_hide / 1000)
                    )
            );
        } else {
            if (stats["valid"]) {
                share_text += (
                    CTH.SHARE_STATS
                        .replace("{min}", stats["min"])
                        .replace("{mean}", stats["mean"])
                        .replace("{sd}", stats["sd"])
                        .replace("{median}", stats["median"])
                );
            }
        }

        if (CTH.perfect_rounds > 0) {
            share_text += CTH.SHARE_PERFECT_ROUNDS.replace(
                "{perfect_rounds}",
                CTH.format_number_with_units(CTH.perfect_rounds, "perfect round")
            );
        }

        share_text += CTH.SHARE_HASHTAGS;

        CTH.tweet_node.setAttribute(
            "href",
            [
                "https://twitter.com/intent/tweet?text=",
                escape(share_text),
                "&url=",
                escape(CTH.URL)
            ].join("")
        );
        CTH.copy_text_node.value = share_text + " " + CTH.URL;

        CTH.stats_round_node.innerHTML = CTH.rounds;
        CTH.stats_score_node.innerHTML = CTH.score;
        CTH.stats_perfect_rounds_node.innerHTML = CTH.perfect_rounds;

        if (stats["valid"]) {
            CTH.stats_mem_time_mean_node.innerHTML = stats["mean"] + "s";
            CTH.stats_mem_time_min_node.innerHTML = stats["min"] + "s";
            CTH.stats_mem_time_max_node.innerHTML = stats["max"] + "s";
            CTH.stats_mem_time_median_node.innerHTML = stats["median"] + "s";
            CTH.stats_mem_time_sd_node.innerHTML = stats["sd"] + "s";
        } else {
            CTH.stats_mem_time_mean_node.innerHTML = "N/A";
            CTH.stats_mem_time_min_node.innerHTML = "N/A";
            CTH.stats_mem_time_max_node.innerHTML = "N/A";
            CTH.stats_mem_time_median_node.innerHTML = "N/A";
            CTH.stats_mem_time_sd_node.innerHTML = "N/A";
        }

        CTH.game_node.setAttribute("class", "screen");
        CTH.end_node.setAttribute("class", "screen active");
    },

    start_game: function ()
    {
        var key, radio_btn, ex;

        if (CTH.audio_ctx === null) {
            CTH.init_audio();
        }

        for (key in CTH.card_num_nodes) {
            if (CTH.card_num_nodes.hasOwnProperty(key)) {
                radio_btn = CTH.card_num_nodes[key];

                if (radio_btn.checked) {
                    CTH.numbers = Number(radio_btn.value);
                    break;
                }
            }
        }

        for (key in CTH.difficulty_nodes) {
            if (CTH.difficulty_nodes.hasOwnProperty(key)) {
                radio_btn = CTH.difficulty_nodes[key];

                if (radio_btn.checked) {
                    CTH.difficulty = Number(radio_btn.value);
                    break;
                }
            }
        }

        for (key in CTH.rounds_nodes) {
            if (CTH.rounds_nodes.hasOwnProperty(key)) {
                radio_btn = CTH.rounds_nodes[key];

                if (radio_btn.checked) {
                    CTH.rounds = Number(radio_btn.value);
                    break;
                }
            }
        }

        for (key in CTH.auto_hide_nodes) {
            if (CTH.auto_hide_nodes.hasOwnProperty(key)) {
                radio_btn = CTH.auto_hide_nodes[key];

                if (radio_btn.checked) {
                    if (key === "auto-hide-0") {
                        CTH.auto_hide = null;
                    } else {
                        CTH.auto_hide = Number(radio_btn.value);
                    }
                    break;
                }
            }
        }

        CTH.round = 0;
        CTH.score = 0;
        CTH.perfect_rounds = 0;
        CTH.memorization_times = [];
        CTH.intro_node.setAttribute("class", "screen");
        CTH.game_node.setAttribute("class", "screen active");
        CTH.prepare_next_round();

        return false;
    },

    restart_game: function ()
    {
        CTH.end_node.setAttribute("class", "screen");
        CTH.intro_node.setAttribute("class", "screen active");
    },

    select: function ()
    {
        CTH.copy_text_node.select();
        CTH.copy_text_node.setSelectionRange(0, 99999);
    },

    copy: function ()
    {
        CTH.select();
        navigator.clipboard.writeText(CTH.copy_text_node.value);
    },

    init_audio: function ()
    {
        var partials = 24,
            soft_saw_coef = new Float32Array(partials),
            soft_sqr_coef = new Float32Array(partials),
            real = new Float32Array(partials),
            plus_or_minus_one, two_over_i_pi, softener,
            i, j;

        try {
            CTH.audio_ctx = new AudioContext();
        } catch (ex) {
            return;
        }

        soft_saw_coef[0] = 0.0;
        soft_sqr_coef[0] = 0.0;
        real[0] = 0.0;

        for (i = 0; i < partials; ++i) {
            j = i + 1;
            plus_or_minus_one = ((i & 1) == 1 ? -1.0 : 1.0);
            two_over_i_pi = 2.0 / (j * Math.PI);
            softener = 5.0 / (i + 5.0);

            soft_saw_coef[j] = softener * plus_or_minus_one * two_over_i_pi;
            soft_sqr_coef[j] = (
                softener * (1.0 + plus_or_minus_one) * two_over_i_pi
            );
            real[j] = 0.0;
        }

        CTH.soft_saw_wave = new PeriodicWave(
            CTH.audio_ctx,
            {
                "channelCount": 1,
                "disableNormalization": false,
                "real": real,
                "imag": soft_saw_coef
            }
        );
        CTH.soft_sqr_wave = new PeriodicWave(
            CTH.audio_ctx,
            {
                "channelCount": 1,
                "disableNormalization": false,
                "real": real,
                "imag": soft_sqr_coef
            }
        );

        CTH.win_lfo_freq_shaper_curve = new Float32Array(
            [0.0, CTH.win_frequency]
        );
        CTH.win_lfo_amp_shaper_curve = new Float32Array(
            [1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0]
        );

        CTH.wrong_frequency_2 = (
            CTH.wrong_frequency_1 * Math.pow(2.0, -19.0 / 12.0)
        );
        CTH.wrong_amp_curve = new Float32Array([-1.0, 1.0]);
        CTH.wrong_freq_curve = new Float32Array(
            [0.0, CTH.wrong_frequency_1 * 2.5]
        );
    },

    init: function ()
    {
        var game = $("game"),
            body = document.getElementsByTagName("body")[0],
            i, key, card_node;

        for (i = 3; i < 10; ++i) {
            key = "cards-" + String(i);
            CTH.card_num_nodes[key] = $(key);
        }

        for (i = 1; i < 4; ++i) {
            key = "difficulty-" + String(i);
            CTH.difficulty_nodes[key] = $(key);
        }

        for (i = 0; i < 3; ++i) {
            key = "rounds-" + String(i);
            CTH.rounds_nodes[key] = $(key);
        }

        for (i = 0; i < 8; ++i) {
            key = "auto-hide-" + String(i);
            CTH.auto_hide_nodes[key] = $(key);
        }

        CTH.start_round_btn_node = $("start-round");
        CTH.mute_node = $("mute");
        CTH.audio_nodes = {
            "audio-click": $("audio-click"),
            "audio-win": $("audio-win"),
            "audio-wrong": $("audio-wrong"),
        };
        CTH.copy_text_node = $("copy-text");
        CTH.tweet_node = $("tweet");
        CTH.stats_round_node = $("stats-rounds");
        CTH.stats_score_node = $("stats-score");
        CTH.stats_perfect_rounds_node = $("stats-perfect-rounds");
        CTH.game_node = game;
        CTH.end_node = $("end");
        CTH.intro_node = $("intro");
        CTH.stats_mem_time_mean_node = $("stats-mem-time-mean");
        CTH.stats_mem_time_min_node = $("stats-mem-time-min");
        CTH.stats_mem_time_max_node = $("stats-mem-time-max");
        CTH.stats_mem_time_median_node = $("stats-mem-time-median");
        CTH.stats_mem_time_sd_node = $("stats-mem-time-sd");
        CTH.status_text_node = $("status-text");

        for (i = 0; i < CTH.CARDS; ++i) {
            card_node = document.createElement("div");
            card_node.setAttribute("class", "card hidden");
            card_node.setAttribute("id", "card-" + String(i));
            CTH.card_nodes.push(card_node);
            game.appendChild(card_node);
        }

        body.addEventListener("mousedown", CTH.handle_card_touch, false);
        $("form").addEventListener("submit", function (evt) {
            evt.stopPropagation();
            evt.preventDefault();
        });
        $("start").addEventListener("click", CTH.start_game);
        $("restart").addEventListener("click", CTH.restart_game);
        CTH.start_round_btn_node.addEventListener("click", CTH.start_round);
        CTH.copy_text_node.addEventListener("click", CTH.select);
        $("copy-button").addEventListener("click", CTH.copy);
    }
}

window.onload = CTH.init;

})();

//-->
</script>
</body>
</html>
